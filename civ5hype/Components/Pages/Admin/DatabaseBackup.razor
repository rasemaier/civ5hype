@page "/admin/database-backup"
@using civ5hype.Data
@using civ5hype.Data.Models
@using civ5hype.Data.Enums
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using System.Text
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Extensions.Caching.Memory
@using System.IO.Compression
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IMemoryCache MemoryCache
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Datenbank Backup</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-danger text-white">
                    <h3 class="mb-0">üíæ Datenbank Backup & Restore</h3>
                    <p class="mb-0 small">Export und Import der gesamten Datenbank</p>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert alert-@(isError ? "danger" : "success") alert-dismissible fade show">
                            @message
                        </div>
                    }

                    <div class="row">
                        <!-- Export -->
                        <div class="col-md-6 mb-4">
                            <div class="card bg-light">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">üì§ Datenbank Export</h5>
                                </div>
                                <div class="card-body">
                                    <p>Exportiere alle Daten:</p>
                                    <ul class="small">
                                        <li>üìÑ JSON-Datei (Spieler, Spiele, Zuordnungen)</li>
                                        <li>üì∏ ZIP-Datei (Screenshots)</li>
                                    </ul>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="includeScreenshots" @bind="includeScreenshots">
                                            <label class="form-check-label" for="includeScreenshots">
                                                Screenshots einschlie√üen (ZIP)
                                            </label>
                                        </div>
                                    </div>
                                    <form method="post" @onsubmit="ExportDatabase" @formname="export-form">
                                        <AntiforgeryToken />
                                        <button type="submit" class="btn btn-success" disabled="@isExporting">
                                            @if (isExporting)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                                <span>Exportiere...</span>
                                            }
                                            else
                                            {
                                                <span>üíæ Export starten</span>
                                            }
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Import -->
                        <div class="col-md-6 mb-4">
                            <div class="card bg-light">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0">üì• Datenbank Import</h5>
                                </div>
                                <div class="card-body">
                                    <p>Importiere Daten:</p>
                                    <div class="alert alert-warning small">
                                        <strong>‚ö†Ô∏è Achtung:</strong> Bestehende Daten werden √ºberschrieben!
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">1Ô∏è‚É£ JSON-Datei (erforderlich)</label>
                                        <InputFile OnChange="HandleJsonFileSelected" accept=".json" class="form-control" />
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">2Ô∏è‚É£ Screenshots ZIP (optional)</label>
                                        <InputFile OnChange="HandleZipFileSelected" accept=".zip" class="form-control" />
                                    </div>
                                    
                                    <button class="btn btn-warning" @onclick="ImportDatabase" disabled="@IsImportDisabled">
                                        @if (isImporting)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            <span>Importiere...</span>
                                        }
                                        else
                                        {
                                            <span>üì• Import starten</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiken -->
                    <div class="card bg-light mt-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">üìä Datenbank Statistiken</h5>
                        </div>
                        <div class="card-body">
                            @if (stats != null)
                            {
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-primary">@stats.PlayerCount</h3>
                                                <p class="mb-0">Spieler</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-success">@stats.GameCount</h3>
                                                <p class="mb-0">Spiele</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-warning">@stats.GamePlayerCount</h3>
                                                <p class="mb-0">Spiel-Eintr√§ge</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool isExporting = false;
    private bool isImporting = false;
    private string? message;
    private bool isError = false;
    private IBrowserFile? selectedJsonFile;
    private IBrowserFile? selectedZipFile;
    private DatabaseStats? stats;
    private bool canAccess = false;
    private string? currentUserId;
    private bool includeScreenshots = true;
    
    private bool IsImportDisabled => selectedJsonFile == null || isImporting;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            // Check if user is Admin
            var appUser = await DbContext.Users.FindAsync(currentUserId);
            canAccess = appUser?.Role == UserRole.Admin;
        }

        if (canAccess)
        {
            await LoadStats();
        }
    }

    private async Task LoadStats()
    {
        stats = new DatabaseStats
        {
            PlayerCount = await DbContext.Players.CountAsync(),
            GameCount = await DbContext.Games.CountAsync(),
            GamePlayerCount = await DbContext.GamePlayers.CountAsync()
        };
    }

    private async Task ExportDatabase()
    {
        isExporting = true;
        message = null;

        try
        {
            var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            
            // Export JSON
            var export = new
            {
                ExportDate = DateTime.UtcNow,
                Players = await DbContext.Players
                    .Select(p => new { p.Id, p.Name, p.CreatedAt, p.UserId })
                    .ToListAsync(),
                Games = await DbContext.Games
                    .Select(g => new { g.Id, g.PlayedOn, g.Comment, g.WinRound, g.CreatedById, g.CreatedAt })
                    .ToListAsync(),
                GamePlayers = await DbContext.GamePlayers
                    .Select(gp => new { 
                        gp.Id, gp.GameId, gp.PlayerId, gp.Rank, gp.IsWinner, 
                        gp.Civilization, gp.SkillLevel, gp.HalberSiegOpStart, 
                        gp.SiegerDerHerzen, gp.Betrueger 
                    })
                    .ToListAsync()
            };

            using var jsonStream = new MemoryStream();
            await JsonSerializer.SerializeAsync(jsonStream, export, new JsonSerializerOptions { WriteIndented = false });
            var jsonBytes = jsonStream.ToArray();
            var jsonFileName = $"civ5hype_backup_{timestamp}.json";
            
            var jsonDownloadId = Guid.NewGuid().ToString();
            MemoryCache.Set($"backup_{jsonDownloadId}", jsonBytes, TimeSpan.FromMinutes(5));

            // Export Screenshots ZIP if requested
            if (includeScreenshots)
            {
                var gamesWithScreenshots = await DbContext.Games
                    .Where(g => g.ScreenshotData != null)
                    .Select(g => new { g.Id, g.ScreenshotData })
                    .ToListAsync();

                if (gamesWithScreenshots.Any())
                {
                    using var zipStream = new MemoryStream();
                    using (var archive = new ZipArchive(zipStream, ZipArchiveMode.Create, true))
                    {
                        foreach (var game in gamesWithScreenshots)
                        {
                            if (!string.IsNullOrEmpty(game.ScreenshotData))
                            {
                                // Extract base64 data (remove "data:image/...;base64," prefix)
                                var base64Data = game.ScreenshotData.Contains(",") 
                                    ? game.ScreenshotData.Split(',')[1] 
                                    : game.ScreenshotData;
                                
                                var imageBytes = Convert.FromBase64String(base64Data);
                                
                                // Determine file extension from data URL
                                var extension = ".jpg";
                                if (game.ScreenshotData.Contains("image/png")) extension = ".png";
                                else if (game.ScreenshotData.Contains("image/gif")) extension = ".gif";
                                else if (game.ScreenshotData.Contains("image/webp")) extension = ".webp";
                                
                                var entry = archive.CreateEntry($"game_{game.Id}{extension}");
                                using var entryStream = entry.Open();
                                await entryStream.WriteAsync(imageBytes, 0, imageBytes.Length);
                            }
                        }
                    }

                    var zipBytes = zipStream.ToArray();
                    var zipFileName = $"civ5hype_screenshots_{timestamp}.zip";
                    
                    var zipDownloadId = Guid.NewGuid().ToString();
                    MemoryCache.Set($"backup_{zipDownloadId}", zipBytes, TimeSpan.FromMinutes(5));

                    // Download ZIP first
                    Navigation.NavigateTo($"/admin/download-backup?id={zipDownloadId}&filename={Uri.EscapeDataString(zipFileName)}", forceLoad: true);
                    
                    // Wait a bit, then download JSON
                    await Task.Delay(1000);
                }
            }

            // Download JSON
            Navigation.NavigateTo($"/admin/download-backup?id={jsonDownloadId}&filename={Uri.EscapeDataString(jsonFileName)}", forceLoad: true);

            message = includeScreenshots 
                ? $"‚úÖ Export erfolgreich! JSON und ZIP werden heruntergeladen..."
                : $"‚úÖ Export erfolgreich! JSON wird heruntergeladen...";
            isError = false;
        }
        catch (Exception ex)
        {
            message = $"‚ùå Fehler beim Export: {ex.Message}";
            isError = true;
        }
        finally
        {
            isExporting = false;
        }
    }

    private void HandleJsonFileSelected(InputFileChangeEventArgs e)
    {
        selectedJsonFile = e.File;
        message = $"JSON-Datei ausgew√§hlt: {selectedJsonFile.Name}";
        isError = false;
    }

    private void HandleZipFileSelected(InputFileChangeEventArgs e)
    {
        selectedZipFile = e.File;
        message = $"ZIP-Datei ausgew√§hlt: {selectedZipFile.Name}";
        isError = false;
    }

    private async Task ImportDatabase()
    {
        if (selectedJsonFile == null) return;

        isImporting = true;
        message = null;

        try
        {
            using var jsonStream = selectedJsonFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024); // 50 MB
            var export = await JsonSerializer.DeserializeAsync<DatabaseExport>(jsonStream);

            if (export == null)
            {
                throw new Exception("Ung√ºltiges Backup-Format");
            }

            // Get current user ID (admin who is doing the import)
            var currentUserId = (await AuthenticationStateProvider.GetAuthenticationStateAsync())
                .User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(currentUserId))
            {
                throw new Exception("Benutzer nicht authentifiziert");
            }

            // Clear existing data
            DbContext.GamePlayers.RemoveRange(DbContext.GamePlayers);
            DbContext.Games.RemoveRange(DbContext.Games);
            DbContext.Players.RemoveRange(DbContext.Players);
            await DbContext.SaveChangesAsync();

            // Import Players first
            if (export.Players != null && export.Players.Any())
            {
                await DbContext.Players.AddRangeAsync(export.Players);
                await DbContext.SaveChangesAsync();
            }

            // Import Games - fix CreatedById to current user if the original user doesn't exist
            if (export.Games != null && export.Games.Any())
            {
                foreach (var game in export.Games)
                {
                    // Check if the CreatedById user exists
                    var userExists = await DbContext.Users.AnyAsync(u => u.Id == game.CreatedById);
                    if (!userExists)
                    {
                        // Set to current user if original creator doesn't exist
                        game.CreatedById = currentUserId;
                    }
                }
                await DbContext.Games.AddRangeAsync(export.Games);
                await DbContext.SaveChangesAsync();
            }

            // Import GamePlayers last
            if (export.GamePlayers != null && export.GamePlayers.Any())
            {
                await DbContext.GamePlayers.AddRangeAsync(export.GamePlayers);
                await DbContext.SaveChangesAsync();
            }

            var importedCount = export.Players?.Count ?? 0;
            var gamesCount = export.Games?.Count ?? 0;

            // Import Screenshots from ZIP if provided
            int screenshotsImported = 0;
            if (selectedZipFile != null)
            {
                // First, read the entire ZIP into memory
                using var zipFileStream = selectedZipFile.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024); // 100 MB for ZIP
                using var zipMemoryStream = new MemoryStream();
                await zipFileStream.CopyToAsync(zipMemoryStream);
                zipMemoryStream.Position = 0;

                using var archive = new ZipArchive(zipMemoryStream, ZipArchiveMode.Read);

                foreach (var entry in archive.Entries)
                {
                    // Extract game ID from filename (e.g., "game_123.jpg" -> 123)
                    var fileName = Path.GetFileNameWithoutExtension(entry.Name);
                    if (fileName.StartsWith("game_") && int.TryParse(fileName.Substring(5), out int gameId))
                    {
                        var game = await DbContext.Games.FindAsync(gameId);
                        if (game != null)
                        {
                            using var entryStream = entry.Open();
                            using var ms = new MemoryStream();
                            await entryStream.CopyToAsync(ms);
                            var imageBytes = ms.ToArray();

                            // Determine MIME type from file extension
                            var extension = Path.GetExtension(entry.Name).ToLowerInvariant();
                            var mimeType = extension switch
                            {
                                ".png" => "image/png",
                                ".gif" => "image/gif",
                                ".webp" => "image/webp",
                                _ => "image/jpeg"
                            };

                            // Convert to base64 data URL
                            var base64 = Convert.ToBase64String(imageBytes);
                            game.ScreenshotData = $"data:{mimeType};base64,{base64}";
                            screenshotsImported++;
                        }
                    }
                }

                await DbContext.SaveChangesAsync();
            }

            await LoadStats();

            message = selectedZipFile != null
                ? $"‚úÖ Import erfolgreich! {importedCount} Spieler, {gamesCount} Spiele, {screenshotsImported} Screenshots importiert."
                : $"‚úÖ Import erfolgreich! {importedCount} Spieler, {gamesCount} Spiele importiert.";
            isError = false;
        }
        catch (Exception ex)
        {
            var innerMessage = ex.InnerException?.Message ?? ex.Message;
            var fullMessage = ex.InnerException != null 
                ? $"{ex.Message} | Inner: {innerMessage}" 
                : ex.Message;
            message = $"‚ùå Fehler beim Import: {fullMessage}";
            isError = true;
            
            // Log to console for debugging
            Console.WriteLine($"Import error: {ex}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"Inner exception: {ex.InnerException}");
            }
        }
        finally
        {
            isImporting = false;
            selectedJsonFile = null;
            selectedZipFile = null;
        }
    }

    private class DatabaseExport
    {
        public DateTime ExportDate { get; set; }
        public List<Player>? Players { get; set; }
        public List<Game>? Games { get; set; }
        public List<GamePlayer>? GamePlayers { get; set; }
    }

    private class DatabaseStats
    {
        public int PlayerCount { get; set; }
        public int GameCount { get; set; }
        public int GamePlayerCount { get; set; }
    }
}

