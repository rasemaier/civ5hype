@page "/admin/database-backup"
@using civ5hype.Data
@using civ5hype.Data.Models
@using civ5hype.Data.Enums
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using System.Text
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Extensions.Caching.Memory
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IMemoryCache MemoryCache
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Datenbank Backup</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-danger text-white">
                    <h3 class="mb-0">üíæ Datenbank Backup & Restore</h3>
                    <p class="mb-0 small">Export und Import der gesamten Datenbank</p>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert alert-@(isError ? "danger" : "success") alert-dismissible fade show">
                            @message
                        </div>
                    }

                    <div class="row">
                        <!-- Export -->
                        <div class="col-md-6 mb-4">
                            <div class="card bg-light">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">üì§ Datenbank Export</h5>
                                </div>
                                <div class="card-body">
                                    <p>Exportiere alle Daten als JSON-Datei:</p>
                                    <ul class="small">
                                        <li>Spieler</li>
                                        <li>Spiele</li>
                                        <li>Spiel-Spieler Zuordnungen</li>
                                    </ul>
                                    <form method="post" @onsubmit="ExportDatabase" @formname="export-form">
                                        <AntiforgeryToken />
                                        <button type="submit" class="btn btn-success" disabled="@isExporting">
                                            @if (isExporting)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                                <span>Exportiere...</span>
                                            }
                                            else
                                            {
                                                <span>üíæ Export starten</span>
                                            }
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Import -->
                        <div class="col-md-6 mb-4">
                            <div class="card bg-light">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0">üì• Datenbank Import</h5>
                                </div>
                                <div class="card-body">
                                    <p>Importiere Daten aus JSON-Datei:</p>
                                    <div class="alert alert-warning small">
                                        <strong>‚ö†Ô∏è Achtung:</strong> Bestehende Daten werden √ºberschrieben!
                                    </div>
                                    <InputFile OnChange="HandleFileSelected" accept=".json" class="form-control mb-2" />
                                    <button class="btn btn-warning" @onclick="ImportDatabase" disabled="@IsImportDisabled">
                                        @if (isImporting)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            <span>Importiere...</span>
                                        }
                                        else
                                        {
                                            <span>üì• Import starten</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiken -->
                    <div class="card bg-light mt-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">üìä Datenbank Statistiken</h5>
                        </div>
                        <div class="card-body">
                            @if (stats != null)
                            {
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-primary">@stats.PlayerCount</h3>
                                                <p class="mb-0">Spieler</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-success">@stats.GameCount</h3>
                                                <p class="mb-0">Spiele</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 class="text-warning">@stats.GamePlayerCount</h3>
                                                <p class="mb-0">Spiel-Eintr√§ge</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool isExporting = false;
    private bool isImporting = false;
    private string? message;
    private bool isError = false;
    private IBrowserFile? selectedFile;
    private DatabaseStats? stats;
    private bool canAccess = false;
    private string? currentUserId;
    
    private bool IsImportDisabled => selectedFile == null || isImporting;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            // Check if user is Admin
            var appUser = await DbContext.Users.FindAsync(currentUserId);
            canAccess = appUser?.Role == UserRole.Admin;
        }

        if (canAccess)
        {
            await LoadStats();
        }
    }

    private async Task LoadStats()
    {
        stats = new DatabaseStats
        {
            PlayerCount = await DbContext.Players.CountAsync(),
            GameCount = await DbContext.Games.CountAsync(),
            GamePlayerCount = await DbContext.GamePlayers.CountAsync()
        };
    }

    private async Task ExportDatabase()
    {
        isExporting = true;
        message = null;

        try
        {
            var export = new DatabaseExport
            {
                ExportDate = DateTime.UtcNow,
                Players = await DbContext.Players.ToListAsync(),
                Games = await DbContext.Games.ToListAsync(),
                GamePlayers = await DbContext.GamePlayers.ToListAsync()
            };

            var json = JsonSerializer.Serialize(export, new JsonSerializerOptions
            {
                WriteIndented = true
            });

            var bytes = Encoding.UTF8.GetBytes(json);
            var fileName = $"civ5hype_backup_{DateTime.Now:yyyyMMdd_HHmmss}.json";
            
            // Store in memory cache with unique ID
            var downloadId = Guid.NewGuid().ToString();
            MemoryCache.Set($"backup_{downloadId}", bytes, TimeSpan.FromMinutes(5));

            // Redirect to download endpoint
            Navigation.NavigateTo($"/admin/download-backup?id={downloadId}&filename={Uri.EscapeDataString(fileName)}", forceLoad: true);

            message = $"‚úÖ Export erfolgreich! Download startet...";
            isError = false;
        }
        catch (Exception ex)
        {
            message = $"‚ùå Fehler beim Export: {ex.Message}";
            isError = true;
        }
        finally
        {
            isExporting = false;
        }
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        message = $"Datei ausgew√§hlt: {selectedFile.Name}";
        isError = false;
    }

    private async Task ImportDatabase()
    {
        if (selectedFile == null) return;

        isImporting = true;
        message = null;

        try
        {
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024); // 50 MB
            var export = await JsonSerializer.DeserializeAsync<DatabaseExport>(stream);

            if (export == null)
            {
                throw new Exception("Ung√ºltiges Backup-Format");
            }

            // Clear existing data
            DbContext.GamePlayers.RemoveRange(DbContext.GamePlayers);
            DbContext.Games.RemoveRange(DbContext.Games);
            DbContext.Players.RemoveRange(DbContext.Players);
            await DbContext.SaveChangesAsync();

            // Import new data
            if (export.Players != null)
            {
                await DbContext.Players.AddRangeAsync(export.Players);
            }
            if (export.Games != null)
            {
                await DbContext.Games.AddRangeAsync(export.Games);
            }
            if (export.GamePlayers != null)
            {
                await DbContext.GamePlayers.AddRangeAsync(export.GamePlayers);
            }

            await DbContext.SaveChangesAsync();
            await LoadStats();

            message = $"‚úÖ Import erfolgreich! {export.Players?.Count ?? 0} Spieler, {export.Games?.Count ?? 0} Spiele importiert.";
            isError = false;
        }
        catch (Exception ex)
        {
            message = $"‚ùå Fehler beim Import: {ex.Message}";
            isError = true;
        }
        finally
        {
            isImporting = false;
            selectedFile = null;
        }
    }

    private class DatabaseExport
    {
        public DateTime ExportDate { get; set; }
        public List<Player>? Players { get; set; }
        public List<Game>? Games { get; set; }
        public List<GamePlayer>? GamePlayers { get; set; }
    }

    private class DatabaseStats
    {
        public int PlayerCount { get; set; }
        public int GameCount { get; set; }
        public int GamePlayerCount { get; set; }
    }
}

