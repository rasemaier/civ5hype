@page "/players"
@using civ5hype.Data.Models
@using civ5hype.Services
@using Microsoft.AspNetCore.Authorization
@inject PlayerService PlayerService
@inject NavigationManager Navigation
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Spieler</PageTitle>

<h1>Spieler</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowAddPlayer">Neuer Spieler</button>
</div>

@if (players == null)
{
    <p><em>Laden...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Verknüpfter User</th>
                <th>Erstellt am</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var player in players)
            {
                <tr>
                    <td>@player.Name</td>
                    <td>@(player.User?.UserName ?? "-")</td>
                    <td>@player.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")</td>
                    <td>
                        <button class="btn btn-sm btn-warning" @onclick="() => EditPlayer(player)">Bearbeiten</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeletePlayer(player.Id)">Löschen</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (showDialog)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingPlayer?.Id > 0 ? "Spieler bearbeiten" : "Neuer Spieler")</h5>
                    <button type="button" class="btn-close" @onclick="CloseDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" @bind="editingPlayer!.Name" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDialog">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="SavePlayer">Speichern</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@code {
    private List<Player>? players;
    private bool showDialog = false;
    private Player? editingPlayer;

    protected override async Task OnInitializedAsync()
    {
        await LoadPlayers();
    }

    private async Task LoadPlayers()
    {
        players = await PlayerService.GetAllPlayersAsync();
    }

    private void ShowAddPlayer()
    {
        editingPlayer = new Player();
        showDialog = true;
    }

    private void EditPlayer(Player player)
    {
        editingPlayer = new Player
        {
            Id = player.Id,
            Name = player.Name,
            UserId = player.UserId
        };
        showDialog = true;
    }

    private async Task SavePlayer()
    {
        if (editingPlayer != null)
        {
            if (editingPlayer.Id > 0)
            {
                await PlayerService.UpdatePlayerAsync(editingPlayer);
            }
            else
            {
                await PlayerService.CreatePlayerAsync(editingPlayer);
            }
            await LoadPlayers();
            CloseDialog();
        }
    }

    private async Task DeletePlayer(int id)
    {
        if (confirm("Möchten Sie diesen Spieler wirklich löschen?"))
        {
            await PlayerService.DeletePlayerAsync(id);
            await LoadPlayers();
        }
    }

    private void CloseDialog()
    {
        showDialog = false;
        editingPlayer = null;
    }

    private bool confirm(string message)
    {
        // In production, use JavaScript interop for confirmation
        return true;
    }
}

